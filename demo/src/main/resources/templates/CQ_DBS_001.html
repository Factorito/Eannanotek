<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Prototype - 관리자 계산식 수정</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#3B82F6',
            secondary: '#1E40AF',
            accent: '#06B6D4',
            dark: '#1F2937',
            light: '#F8FAFC'
          }
        }
      }
    }
  </script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

    body {
      font-family: 'Inter', sans-serif;
      background: linear-gradient(120deg, #f5f6fa 0%, #e0e0e0 100%);
    }

    .gradient-bg {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    }

    .glass-effect {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .billboard-shadow {
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
    }

    .building {
      background: linear-gradient(to top, #374151, #4B5563);
    }

    .social-icon {
      transition: all 0.3s ease;
    }

    .social-icon:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.2);
    }

    .nav-link {
      position: relative;
    }

    .nav-link::after {
      content: '';
      position: absolute;
      bottom: -2px;
      left: 0;
      width: 0;
      height: 2px;
      background: #111;
      transition: width 0.3s ease;
    }

    .nav-link:hover::after {
      width: 100%;
    }
    .glass {
      background: rgba(255,255,255,0.7);
      box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.18);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-radius: 1.5rem;
      border: 1px solid rgba(255,255,255,0.18);
    }
    .glass-dark {
      background: rgba(30,30,30,0.7);
      box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.18);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-radius: 1.5rem;
      border: 1px solid rgba(0,0,0,0.18);
    }

    .table-input {
      @apply w-full p-1 text-center bg-transparent border-none focus:outline-none;
    }
    .table-header {
      @apply px-4 py-2 bg-gray-100 font-semibold text-gray-700 text-sm;
    }
    .table-cell {
      @apply px-4 py-2 border border-gray-200 text-sm text-gray-800;
    }

    /* 모달 스타일 */
    .modal {
      display: none; /* Hidden by default */
      position: fixed; /* Stay in place */
      z-index: 1000; /* Sit on top */
      left: 0;
      top: 0;
      width: 100%; /* Full width */
      height: 100%; /* Full height */
      overflow: auto; /* Enable scroll if needed */
      background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background-color: #fefefe;
      margin: auto;
      padding: 20px;
      border-radius: 0.75rem;
      width: 80%;
      max-width: 600px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      position: relative;
    }
    .close-button {
      color: #aaa;
      float: right;
      font-size: 28px;
      font-weight: bold;
    }
    .close-button:hover,
    .close-button:focus {
      color: black;
      text-decoration: none;
      cursor: pointer;
    }
    .loading-spinner {
      border: 4px solid rgba(0, 0, 0, 0.1);
      border-top: 4px solid #3B82F6;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 20px auto;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
  </style>
</head>
<body class="bg-gradient-to-br from-white to-gray-200 min-h-screen flex flex-col">

<!-- 헤더 -->
<header class="fixed top-0 w-full bg-white/80 backdrop-blur-md shadow-lg z-50">
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="text-center py-2">
      <a href="/prototype/main" class="text-sm text-gray-800 font-semibold hover:underline">PrototypeV1.2.1</a>
    </div>
    <div class="flex items-center justify-between py-4">
      <!-- 로고 -->
      <div class="flex items-center space-x-4">
        <a href="http://eannanotek.com/" target="_blank" rel="noopener noreferrer">
          <img src="/Eannanotek.png" alt="Eannanotek 로고" class="w-12 h-12 object-contain" />
        </a>
      </div>
      <!-- 검색바 -->
      <div class="flex-1 max-w-md mx-8">
        <div class="relative">
          <input type="text"
                 placeholder="검색어를 입력해주세요."
                 class="w-full px-4 py-3 pl-12 pr-4 glass border border-gray-200 rounded-full focus:outline-none focus:ring-2 focus:ring-black focus:border-transparent transition-all duration-300 text-gray-900 placeholder-gray-400">
          <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
            <svg class="h-5 w-5 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
            </svg>
          </div>
        </div>
      </div>
      <!-- 네비게이션 -->
      <nav class="flex items-center space-x-6">
        <a href="/prototype/qeq1" class="nav-link text-gray-900 hover:text-black font-medium transition-colors duration-300">견적 신청</a>
        <a href="#history" class="nav-link text-gray-900 hover:text-black font-medium transition-colors duration-300">이력 조회</a>
        <a href="/prototype/mi" class="nav-link text-gray-900 hover:text-black font-medium transition-colors duration-300">재료/부품 정보</a>
        <a href="#faq" class="nav-link text-gray-900 hover:text-black font-medium transition-colors duration-300">FAQ</a>
        <a href="/prototype/write" class="nav-link text-gray-900 hover:text-black font-medium transition-colors duration-300">글쓰기</a>
        <th:block th:if="${session.user == null}">
          <a href="/prototype/login" class="px-4 py-2 bg-black text-white rounded-lg hover:bg-gray-800">Sign In</a>
          <a href="/prototype/register" class="px-4 py-2 bg-white border border-gray-300 text-gray-800 rounded-lg hover:bg-gray-100">Register</a>
        </th:block>

        <th:block th:if="${session.user != null}">
          <a href="/prototype/main-settings"><span class="text-gray-700">[ <b th:text="${session.user.email}">사용자</b> ]</span></a>
          <form th:action="@{/prototype/logout}" method="post" style="display:inline;">

            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
            <button type="submit" class="px-4 py-2 bg-gray-100 border border-gray-300 text-gray-800 rounded-lg hover:bg-gray-200">
              로그아웃
            </button>
          </form>
        </th:block>
      </nav>
    </div>
  </div>
</header>

<!-- 메인 컨텐츠 - 계산식 수정 테이블 -->
<main class="flex-grow flex justify-center py-20 px-4 sm:px-6 lg:px-8 mt-16">
  <div class="glass bg-white/80 p-8 rounded-xl shadow-xl w-full max-w-6xl">
    <h2 class="text-2xl font-bold text-gray-800 text-center mb-8">계산식 관리 (관리자)</h2>

    <form action="/admin/update-formulas" method="post">
      <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">

      <div class="overflow-x-auto rounded-lg border border-gray-200 shadow-sm mb-8">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gray-50">
          <tr>
            <th class="table-header">모델 구분</th>
            <th class="table-header">수량</th>
            <th class="table-header">소비전력</th>
            <th class="table-header">모델 단가</th>
            <th class="table-header">사이즈</th>
            <th class="table-header">밝기</th>
            <th class="table-header">옥외/실내 구분</th>
            <th class="table-header">해상도</th>
            <th class="table-header">칩</th>
            <th class="table-header">기타</th>
            <th class="table-header">LLM 설명</th> <!-- 새로운 헤더 추가 -->
          </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
          <!-- 예시 데이터 행 (실제로는 DB에서 불러와서 Thymeleaf 반복문으로 생성) -->
          <tr th:each="formula, stat : ${formulas}">
            <td class="table-cell font-medium" th:text="${formula.modelName}">Q1.25</td>
            <td class="table-cell"><input type="text" th:name="'formulas[' + ${stat.index} + '].quantity'" th:value="${formula.quantity}" class="table-input"></td>
            <td class="table-cell"><input type="text" th:name="'formulas[' + ${stat.index} + '].powerConsumption'" th:value="${formula.powerConsumption}" class="table-input"></td>
            <td class="table-cell"><input type="text" th:name="'formulas[' + ${stat.index} + '].unitPrice'" th:value="${formula.unitPrice}" class="table-input"></td>
            <td class="table-cell"><input type="text" th:name="'formulas[' + ${stat.index} + '].size'" th:value="${formula.size}" class="table-input"></td>
            <td class="table-cell"><input type="text" th:name="'formulas[' + ${stat.index} + '].brightness'" th:value="${formula.brightness}" class="table-input"></td>
            <td class="table-cell"><input type="text" th:name="'formulas[' + ${stat.index} + '].outdoorIndoor'" th:value="${formula.outdoorIndoor}" class="table-input"></td>
            <td class="table-cell"><input type="text" th:name="'formulas[' + ${stat.index} + '].resolution'" th:value="${formula.resolution}" class="table-input"></td>
            <td class="table-cell"><input type="text" th:name="'formulas[' + ${stat.index} + '].chip'" th:value="${formula.chip}" class="table-input"></td>
            <td class="table-cell">
              <div class="flex items-center space-x-2">
                <input type="text" th:name="'formulas[' + ${stat.index} + '].etc'" th:value="${formula.etc}" class="table-input flex-grow">
                <button type="button" class="px-2 py-1 bg-blue-500 text-white rounded-md text-xs whitespace-nowrap llm-explain-btn" data-formula-target="etc">✨</button>
              </div>
            </td>
            <td class="table-cell">
              <div class="flex items-center space-x-2">
                <input type="text" th:name="'formulas[' + ${stat.index} + '].llmExplanation'" th:value="${formula.llmExplanation}" class="table-input flex-grow" readonly>
                <button type="button" class="px-2 py-1 bg-blue-500 text-white rounded-md text-xs whitespace-nowrap llm-explain-btn" data-formula-target="llmExplanation">✨</button>
              </div>
            </td>
            <!-- hidden input으로 모델 이름을 함께 전송하여 어떤 모델의 값인지 식별 -->
            <input type="hidden" th:name="'formulas[' + ${stat.index} + '].modelName'" th:value="${formula.modelName}">
          </tr>
          <!-- 더미 데이터 (반복문을 위해 몇 개 더 추가) -->
          <tr>
            <td class="table-cell font-medium">Q1.53</td>
            <td class="table-cell"><input type="text" name="formulas[1].quantity" value="10" class="table-input"></td>
            <td class="table-cell"><input type="text" name="formulas[1].powerConsumption" value="500W" class="table-input"></td>
            <td class="table-cell"><input type="text" name="formulas[1].unitPrice" value="1200000" class="table-input"></td>
            <td class="table-cell"><input type="text" name="formulas[1].size" value="1.5x1m" class="table-input"></td>
            <td class="table-cell"><input type="text" name="formulas[1].brightness" value="2000cd" class="table-input"></td>
            <td class="table-cell"><input type="text" name="formulas[1].outdoorIndoor" value="실내" class="table-input"></td>
            <td class="table-cell"><input type="text" name="formulas[1].resolution" value="1920x1080" class="table-in